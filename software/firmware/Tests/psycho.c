#include "versat_accel.h"

#include "system.h"
#include "periphs.h"
#include "string.h"

#include "iob-uart.h"
#include "iob-timer.h"
#include "iob-ila.h"
#include "iob-eth.h"

#include "printf.h"

#define NOISE 10
#define TONE 20
#define DBMIN -200.0f
#define SUBSIZE 136
#define HBLKSIZE 513

int dbtable[] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

int freq_subset[] = {1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,51,53,55,57,59,61,63,65,67,69,71,73,75,77,79,81,83,85,87,89,91,93,95,97,101,105,109,113,117,121,125,129,133,137,141,145,149,153,157,161,165,169,173,177,181,185,189,193,201,209,217,225,233,241,249,257,265,273,281,289,297,305,313,321,329,337,345,353,361,369,377,385,393,401,409,417,425,433,441,449,457,465,473,481,489,497,505};

float bark[] = {0.000000,0.425460,0.850241,1.273448,1.694205,2.111672,2.525051,2.933594,3.336612,3.733479,4.123635,4.506591,4.881925,5.249283,5.608382,5.958998,6.300971,6.634196,6.958618,7.274232,7.581073,7.879211,8.168753,8.449828,8.722594,8.987224,9.243908,9.492850,9.734263,9.968366,10.195381,10.415539,10.629064,10.836185,11.037125,11.232108,11.421352,11.605071,11.783474,11.956764,12.125139,12.288791,12.447904,12.602659,12.753228,12.899777,13.042468,13.181454,13.316883,13.448897,13.577636,13.703226,13.825796,13.945465,14.062349,14.176558,14.288198,14.397370,14.504172,14.608695,14.711029,14.811258,14.909464,15.005725,15.100115,15.192705,15.283565,15.372757,15.460346,15.546391,15.630948,15.714074,15.795819,15.876236,15.955370,16.033268,16.109976,16.185532,16.259979,16.333357,16.405699,16.477045,16.547424,16.616871,16.685417,16.753094,16.819925,16.885941,16.951168,17.015629,17.079350,17.142351,17.204659,17.266289,17.327263,17.387604,17.447325,17.506445,17.564981,17.622950,17.680367,17.737246,17.793600,17.849442,17.904787,17.959646,18.014030,18.067951,18.121418,18.174442,18.227034,18.279200,18.330950,18.382292,18.433233,18.483782,18.533945,18.583729,18.633141,18.682184,18.730869,18.779196,18.827173,18.874805,18.922094,18.969048,19.015669,19.061960,19.107927,19.153570,19.198896,19.243908,19.288605,19.332993,19.377073,19.420849,19.464321,19.507494,19.550367,19.592947,19.635229,19.677219,19.718920,19.760328,19.801451,19.842285,19.882835,19.923100,19.963081,20.002783,20.042204,20.081345,20.120205,20.158791,20.197098,20.235130,20.272888,20.310373,20.347586,20.384525,20.421194,20.457592,20.493723,20.529583,20.565178,20.600504,20.635567,20.670364,20.704897,20.739166,20.773176,20.806923,20.840410,20.873638,20.906609,20.939322,20.971777,21.003981,21.035927,21.067623,21.099066,21.130259,21.161201,21.191895,21.222342,21.252542,21.282499,21.312212,21.341682,21.370913,21.399900,21.428652,21.457167,21.485443,21.513487,21.541298,21.568876,21.596224,21.623344,21.650236,21.676903,21.703342,21.729563,21.755558,21.781336,21.806892,21.832233,21.857359,21.882271,21.906971,21.931458,21.955736,21.979807,22.003672,22.027330,22.050787,22.074041,22.097097,22.119953,22.142614,22.165077,22.187349,22.209427,22.231316,22.253016,22.274529,22.295855,22.316996,22.337955,22.358736,22.379333,22.399755,22.420002,22.440071,22.459969,22.479694,22.499250,22.518639,22.537859,22.556913,22.575804,22.594532,22.613100,22.631508,22.649757,22.667850,22.685789,22.703575,22.721207,22.738689,22.756021,22.773207,22.790247,22.807140,22.823891,22.840498,22.856966,22.873295,22.889484,22.905537,22.921455,22.937239,22.952888,22.968409,22.983797,22.999058,23.014191,23.029198,23.044079,23.058836,23.073471,23.087984,23.102377,23.116652,23.130808,23.144848,23.158772,23.172583,23.186277,23.199863,23.213337,23.226700,23.239956,23.253103,23.266144,23.279079,23.291910,23.304638,23.317265,23.329788,23.342211,23.354536,23.366762,23.378891,23.390923,23.402859,23.414701,23.426451,23.438107,23.449671,23.461145,23.472530,23.483826,23.495031,23.506151,23.517185,23.528133,23.538998,23.549778,23.560474,23.571089,23.581623,23.592075,23.602449,23.612743,23.622959,23.633099,23.643160,23.653147,23.663059,23.672895,23.682659,23.692348,23.701967,23.711514,23.720989,23.730394,23.739731,23.748999,23.758198,23.767330,23.776396,23.785395,23.794329,23.803198,23.812002,23.820742,23.829420,23.838036,23.846590,23.855082,23.863514,23.871885,23.880198,23.888451,23.896645,23.904781,23.912861,23.920885,23.928850,23.936762,23.944618,23.952419,23.960167,23.967859,23.975500,23.983088,23.990623,23.998106,24.005539,24.012922,24.020254,24.027534,24.034767,24.041952,24.049088,24.056175,24.063213,24.070208,24.077152,24.084053,24.090906,24.097715,24.104479,24.111197,24.117872,24.124502,24.131090,24.137634,24.144136,24.150595,24.157013,24.163389,24.169724,24.176018,24.182272,24.188484,24.194658,24.200792,24.206888,24.212946,24.218964,24.224943,24.230886,24.236792,24.242661,24.248491,24.254286,24.260046,24.265768,24.271456,24.277109,24.282726,24.288309,24.293858,24.299374,24.304853,24.310303,24.315716,24.321098,24.326448,24.331764,24.337049,24.342302,24.347523,24.352715,24.357874,24.363001,24.368099,24.373167,24.378206,24.383213,24.388191,24.393141,24.398062,24.402954,24.407816,24.412651,24.417458,24.422237,24.426989,24.431711,24.436409,24.441078,24.445721,24.450338,24.454927,24.459492,24.464029,24.468542,24.473030,24.477491,24.481928,24.486340,24.490726,24.495089,24.499426,24.503740,24.508032,24.512297,24.516541,24.520760,24.524956,24.529129,24.533279,24.537407,24.541512,24.545595,24.549656,24.553694,24.557711,24.561707,24.565680,24.569632,24.573563,24.577473,24.581362,24.585232,24.589079,24.592907,24.596714,24.600502,24.604269,24.608017,24.611746,24.615454,24.619143,24.622812,24.626463,24.630096,24.633709,24.637304,24.640879,24.644438,24.647976,24.651499,24.655001,24.658487,24.661955,24.665405,24.668837,24.672253,24.675652,24.679031,24.682396,24.685743,24.689074,24.692387,24.695684,24.698965,24.702230,24.705479,24.708712,24.711927,24.715128,24.718313,24.721483,24.724636,24.727776,24.730898,24.734007,24.737099,24.740177};

float Xtm[] = {-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,78.189468,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000};

float Xnm[] = {-200.000000,53.319298,-200.000000,-200.000000,55.083649,-200.000000,53.319298,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,53.319298,-200.000000,56.350948,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,56.350948,-200.000000,-200.000000,-200.000000,56.350948,-200.000000,-200.000000,-200.000000,57.324177,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,58.114273,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,58.781105,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,59.367432,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,60.344238,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,61.137211,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,62.112625,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,62.904690,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,63.576817,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,64.159523,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,64.982048,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,66.154396,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,67.920586,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,70.654922,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,71.466721,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000,-200.000000};

int tonelabel[] = {0,0,0,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

int noiselabel[] = {0,10,0,0,10,0,10,0,0,0,0,0,0,10,0,10,0,0,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,0,0,10,0,0,0,0,0,10,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

#include "stdbool.h"

typedef union{
  int i;
  float f;
} Conv;

int PackInt(float f){
  Conv c = {};
  c.f = f;
  return c.i;
}

#define FLOAT float

static inline FLOAT psycho_3_add_db(FLOAT a, FLOAT b)
{
    /* MFC - if the difference between a and b is large (>99), then just return the largest one.
       (about 10% of the time) - For differences between 0 and 99, return the largest value, but
       add in a pre-calculated difference value. - the value 99 was chosen arbitarily. - maximum
       (a-b) i've seen is 572 */
    FLOAT fdiff;
    int idiff;
    fdiff = (10.0 * (a - b));
    idiff = (int) fdiff;

    FLOAT res;

    if (fdiff > 990.0) {
        res = a;
    } else if (fdiff < -990.0) {
        res = b;
    } else if (idiff >= 0) {
        res = (a + dbtable[idiff]);
    } else {
        res = (b + dbtable[-idiff]);
    }

    int posIdiff = idiff < 0 ? -idiff : idiff;
    //printf("a:%f b:%f fdiff:%f idiff:%d table:%f res:%f",a,b,fdiff,posIdiff,mem->dbtable[posIdiff],res);
    return res;
}

void initVersat(FLOAT const1_av, FLOAT * bark, int *freq_subset){

    ////Mem freq_subset;
    // Memory side  //stored in memory
    ACCEL_TOP_freq_subset_incrA = 1;
    ACCEL_TOP_freq_subset_iterA = 1;
    ACCEL_TOP_freq_subset_shiftA = 1;
    ACCEL_TOP_freq_subset_dutyA = ~0;
    ACCEL_TOP_freq_subset_perA = SUBSIZE;
    VersatMemoryCopy(TOP_freq_subset_addr,freq_subset,SUBSIZE * sizeof(int));
 
    printf("Copied freq\n");
  
    ////LookupTable bark;
    // Memory side
    VersatMemoryCopy(TOP_bark_addr,bark,HBLKSIZE * sizeof(float));

    printf("Copied bark\n");

    ////LookupTable mem;
    // Memory side
    VersatMemoryCopy(TOP_mem_addr,dbtable,1000 * sizeof(int));

    printf("Copied dbtable\n");

    ////////////////////////////// module dzRange()

    ////Const const1_dzRange;
    ACCEL_TOP_dzRange1_const1_dzRange_constant = PackInt(-3.0);

    ////Const const2_dzRange;
    ACCEL_TOP_dzRange1_const2_dzRange_constant = PackInt(8.0);

    ////////////////////////////// module Logic()

    ////Const const1_Logic;
    ACCEL_TOP_logic1_const1_Logic_constant = PackInt(-1.0);

    ////Const const2_Logic;
    ACCEL_TOP_logic1_const2_Logic_constant = PackInt(0.0);

    ////Const const3_Logic;
    ACCEL_TOP_logic1_const3_Logic_constant = PackInt(1.0);

    ////Const const4_Logic;
    ACCEL_TOP_logic1_const4_Logic_constant = 1;

    ////////////////////////////// module vf4()

    ////Const const1_vf4;
    ACCEL_TOP_vf1_const1_vf4_constant = PackInt(17.0);

    ////Const const2_vf4;
    ACCEL_TOP_vf1_const2_vf4_constant = PackInt(1.0);

    ////Const const3_vf4;
    ACCEL_TOP_vf1_const3_vf4_constant = PackInt(0.4);

    ////Const const4_vf4;
    ACCEL_TOP_vf1_const4_vf4_constant = PackInt(6.0);

    ////Const const5_vf4;
    ACCEL_TOP_vf1_const5_vf4_constant = PackInt(-17.0);

    ////Const const6_vf4;
    ACCEL_TOP_vf1_const6_vf4_constant = PackInt(0.15);

    ////////////////////////////// module start()

    ////Const DBMIN;
    ACCEL_TOP_DBMIN_constant = PackInt(DBMIN);

    ////Const const1_av;
    ACCEL_TOP_const1_av_constant = PackInt(const1_av);

    ////Mem LTtmR;
    // Memory side  //stored in memory
    // A
    ACCEL_TOP_LTtmR_iterA = 1;
    ACCEL_TOP_LTtmR_incrA = 1;
    ACCEL_TOP_LTtmR_shiftA = 1;
    ACCEL_TOP_LTtmR_perA = SUBSIZE;
    ACCEL_TOP_LTtmR_dutyA = SUBSIZE;
    ACCEL_TOP_LTtmR_in0_wr = 1;
    // B
    ACCEL_TOP_LTtmR_iterB = 1;
    ACCEL_TOP_LTtmR_incrB = 1;
    ACCEL_TOP_LTtmR_perB = SUBSIZE;
    ACCEL_TOP_LTtmR_dutyB = SUBSIZE;

    ////Const const1_psycho_3;
    ACCEL_TOP_const1_psycho_3_constant = PackInt(10.0);

    ////Const const2_psycho_3;
    ACCEL_TOP_const2_psycho_3_constant = PackInt(990.0);

    ////Const const3_psycho_3;
    ACCEL_TOP_const3_psycho_3_constant = PackInt(-990.0);

    ////Const const4_psycho_3;
    ACCEL_TOP_const4_psycho_3_constant = PackInt(0.0);

    ////Const const5_psycho_3;
    ACCEL_TOP_const5_psycho_3_constant = 1;

}

void configureVersat(bool firstRun, FLOAT const2_av, FLOAT const3_av, FLOAT barkK, FLOAT Xtm){

    if(firstRun){
        ACCEL_TOP_mux2_sel = 0;
    }else{
        ACCEL_TOP_mux2_sel = 1;
    }

    ////Const const2_av;
    ACCEL_TOP_const2_av_constant = PackInt(const2_av);

    ////Const const3_av;
    ACCEL_TOP_const3_av_constant = PackInt(const3_av);

    ////Const barkK;
    ACCEL_TOP_barkK_constant = PackInt(barkK);

    ////Const Xtm;
    ACCEL_TOP_Xtm_constant = PackInt(Xtm);

    printf("RunAccelerator\n");
    RunAccelerator(1);  //module start()
    printf("RunAccelerator done\n");

}

static void psycho_3_threshold()
{
    int i, j, k;
    FLOAT LTtm_correct[SUBSIZE];
    FLOAT LTnm_correct[SUBSIZE];
    FLOAT LTtm[SUBSIZE];
    FLOAT LTnm[SUBSIZE];
    FLOAT LTg_correct[SUBSIZE];

    for (i = 0; i < SUBSIZE; i++) {
        LTtm_correct[i] = DBMIN;
        LTnm_correct[i] = DBMIN;
    }

    bool firstRun = true;

    printf("==== K1 ====\n");

    printf("initVersat\n");
    initVersat(-1.525, bark, freq_subset);
    printf("initVersat done\n");

    /* Loop over the entire spectrum and find every noise and tone And then with each noise/tone
       work out how it masks the spectral lines around it */
    for (k = 1; k < HBLKSIZE; k++) {
        //1st part of loop
        if (tonelabel[k] == TONE) { 
            printf("configureVersat\n");
            configureVersat(firstRun, -0.275, -4.5, bark[k], Xtm[k]);
            firstRun = false;
            printf("configureVersat done\n");
        }            
    }

    for(int i = 0; i < SUBSIZE; i++){
        LTtm[i] = VersatUnitReadFloat(TOP_LTtmR_addr,i);
    }

#if 1
    for(int i = 0; i < 32; i++){
        printf("%f\n",LTtm[i]);
    }
#endif
  
    printf("==== K2 ====\n");

#if 0
    firstRun = true;
    for (k = 1; k < HBLKSIZE; k++) {
        //2nd part of loop
        if (noiselabel[k] == NOISE) {
            printf("configureVersat\n");
            configureVersat(firstRun, -0.175, -0.5, bark[k], Xnm[k]);
            firstRun = false;
            printf("configureVersat done\n");
        }
    }

    printf("VersatUnitReadFloat\n");
    for(int i = 0; i < SUBSIZE; i++){
        LTnm[i] = VersatUnitReadFloat(TOP_LTtmR_addr,i);
    }
#endif

}

int main(int argc,const char* argv[]){
  uart_init(UART_BASE,FREQ/BAUD);
  timer_init(TIMER_BASE);
  ila_init(ILA_BASE);

  printf("Before versat init\n");
  
  versat_init(VERSAT_BASE);

  psycho_3_threshold();

  uart_finish();
  
  return 0;
}
